<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Management - Rice Products</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
        .content-section {
            padding-top: 80px;
        }
        .product-image {
            max-width: 200px;
            max-height: 200px;
            object-fit: contain;
        }
        .product-card {
            margin-bottom: 20px;
        }
        .nav-tabs {
            margin-bottom: 20px;
        }
        .feature-list, .spec-list, .cert-list {
            margin-top: 10px;
        }
        .feature-item, .spec-item, .cert-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .weight-option-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .weight-options-list, .nutritional-info {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <img src="logo.png" alt="Rice Products" height="40">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html#home">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="all_products.html">All Products</a>
                    </li>
                    <li class="nav-item" id="productManagementLink">
                        <a class="nav-link active" href="product_management.html">Product Management</a>
                    </li>
                    <li class="nav-item" id="orderManagementLink">
                        <a class="nav-link" href="order_management.html">Order Management</a>
                    </li>
                    <li class="nav-item" id="authLinks">
                        <a class="nav-link" href="login.html">Login</a>
                    </li>
                    <li class="nav-item" id="logoutLink" style="display: none;">
                        <a class="nav-link" href="#" onclick="logout()">Logout</a>
                    </li>
                    <li class="nav-item" id="addWorkerLink" style="display: none;">
                        <a class="nav-link" href="NewWorker.html">Add Worker</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Content Section -->
    <div class="content-section">
        <div class="container mt-5">
            <h1 class="mb-4">Product Manager</h1>
            
            <!-- Auth Status -->
            <div id="authStatus" class="alert alert-info mb-3" style="display:none;">
                Checking authentication status...
            </div>
            
            <!-- Navigation Tabs -->
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="products-tab" data-bs-toggle="tab" data-bs-target="#products" type="button" role="tab">Products</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="categories-tab" data-bs-toggle="tab" data-bs-target="#categories" type="button" role="tab">Categories</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="certifications-tab" data-bs-toggle="tab" data-bs-target="#certifications" type="button" role="tab">Certifications</button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="myTabContent">
                <!-- Products Tab -->
                <div class="tab-pane fade show active" id="products" role="tabpanel">
                    <!-- Add Product Form -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">Add New Product</h5>
                            <form id="productForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="name" class="form-label">Product Name</label>
                                        <input type="text" class="form-control" id="name" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="categoryId" class="form-label">Category</label>
                                        <select class="form-control" id="categoryId" required>
                                            <!-- Categories will be loaded here -->
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="description" class="form-label">Description</label>
                                    <textarea class="form-control" id="description" rows="3"></textarea>
                                </div>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="pricePerKg" class="form-label">Price per KG</label>
                                        <input type="number" class="form-control" id="pricePerKg" step="0.01" required>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="inventory" class="form-label">Inventory</label>
                                        <input type="number" class="form-control" id="inventory" required>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="productImage" class="form-label">Product Image</label>
                                        <input type="file" class="form-control" id="productImage" accept="image/*">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-3 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="isNewArrival">
                                            <label class="form-check-label" for="isNewArrival">New Arrival</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="isBestSeller">
                                            <label class="form-check-label" for="isBestSeller">Best Seller</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="isFeatured">
                                            <label class="form-check-label" for="isFeatured">Featured</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="hasDiscount">
                                            <label class="form-check-label" for="hasDiscount">Has Discount</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="discountPercentage" class="form-label">Discount %</label>
                                    <input type="number" class="form-control" id="discountPercentage" min="0" max="100">
                                </div>

                                <!-- Features Section -->
                                <div class="mb-3">
                                    <label class="form-label">Features</label>
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control" id="featureInput" placeholder="Add a feature">
                                        <button class="btn btn-outline-secondary" type="button" onclick="addFeature()">Add</button>
                                    </div>
                                    <div id="featuresList" class="feature-list"></div>
                                </div>

                                <!-- Specifications Section -->
                                <div class="mb-3">
                                    <label class="form-label">Specifications</label>
                                    <div class="row mb-2">
                                        <div class="col-md-5">
                                            <input type="text" class="form-control" id="specNameInput" placeholder="Specification name">
                                        </div>
                                        <div class="col-md-5">
                                            <input type="text" class="form-control" id="specValueInput" placeholder="Specification value">
                                        </div>
                                        <div class="col-md-2">
                                            <button class="btn btn-outline-secondary w-100" type="button" onclick="addSpecification()">Add</button>
                                        </div>
                                    </div>
                                    <div id="specificationsList" class="spec-list"></div>
                                </div>

                                <!-- Weight Options Section -->
                                <div class="mb-3">
                                    <label class="form-label">Weight Options</label>
                                    <div class="row mb-2">
                                        <div class="col-md-3">
                                            <input type="number" class="form-control" id="weightValueInput" placeholder="Weight in grams">
                                        </div>
                                        <div class="col-md-3">
                                            <input type="number" class="form-control" id="weightPriceInput" step="0.01" placeholder="Price">
                                        </div>
                                        <div class="col-md-4">
                                            <input type="file" class="form-control" id="packagingPhotoInput" accept="image/*">
                                        </div>
                                        <div class="col-md-2">
                                            <button class="btn btn-outline-secondary w-100" type="button" onclick="addWeightOption()">Add</button>
                                        </div>
                                    </div>
                                    <div id="weightOptionsList" class="weight-options-list"></div>
                                </div>

                                <!-- Nutritional Info Section -->
                                <div class="mb-3">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="hasNutritionalInfo" onchange="toggleNutritionalInfoForm()">
                                        <label class="form-check-label" for="hasNutritionalInfo">Add Nutritional Information</label>
                                    </div>
                                    
                                    <div id="nutritionalInfoForm" style="display: none;">
                                        <div class="row mb-2">
                                            <div class="col-md-6">
                                                <label for="servingSize" class="form-label">Serving Size</label>
                                                <input type="text" class="form-control" id="servingSize">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="servingsPerContainer" class="form-label">Servings Per Container</label>
                                                <input type="text" class="form-control" id="servingsPerContainer">
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-3 mb-2">
                                                <label for="calories" class="form-label">Calories</label>
                                                <input type="text" class="form-control" id="calories">
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <label for="totalFat" class="form-label">Total Fat</label>
                                                <input type="text" class="form-control" id="totalFat">
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <label for="saturatedFat" class="form-label">Saturated Fat</label>
                                                <input type="text" class="form-control" id="saturatedFat">
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <label for="transFat" class="form-label">Trans Fat</label>
                                                <input type="text" class="form-control" id="transFat">
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-3 mb-2">
                                                <label for="cholesterol" class="form-label">Cholesterol</label>
                                                <input type="text" class="form-control" id="cholesterol">
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <label for="sodium" class="form-label">Sodium</label>
                                                <input type="text" class="form-control" id="sodium">
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <label for="totalCarbohydrates" class="form-label">Total Carbohydrates</label>
                                                <input type="text" class="form-control" id="totalCarbohydrates">
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <label for="dietaryFiber" class="form-label">Dietary Fiber</label>
                                                <input type="text" class="form-control" id="dietaryFiber">
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-3 mb-2">
                                                <label for="sugars" class="form-label">Sugars</label>
                                                <input type="text" class="form-control" id="sugars">
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <label for="protein" class="form-label">Protein</label>
                                                <input type="text" class="form-control" id="protein">
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <label for="vitaminA" class="form-label">Vitamin A</label>
                                                <input type="text" class="form-control" id="vitaminA">
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <label for="vitaminC" class="form-label">Vitamin C</label>
                                                <input type="text" class="form-control" id="vitaminC">
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-2">
                                                <label for="calcium" class="form-label">Calcium</label>
                                                <input type="text" class="form-control" id="calcium">
                                            </div>
                                            <div class="col-md-6 mb-2">
                                                <label for="iron" class="form-label">Iron</label>
                                                <input type="text" class="form-control" id="iron">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Certifications Section -->
                                <div class="mb-3">
                                    <label class="form-label">Certifications</label>
                                    <div class="input-group mb-2">
                                        <select class="form-control" id="certificationSelect">
                                            <!-- Certifications will be loaded here -->
                                        </select>
                                        <button class="btn btn-outline-secondary" type="button" onclick="addCertification()">Add</button>
                                    </div>
                                    <div id="selectedProductCertificationsList" class="cert-list"></div>
                                </div>

                                <button type="submit" class="btn btn-primary" id="submitProductBtn">Add Product</button>
                            </form>
                        </div>
                    </div>

                    <!-- Products List -->
                    <div id="productsList" class="row"></div>
                </div>

                <!-- Categories Tab -->
                <div class="tab-pane fade" id="categories" role="tabpanel">
                    <!-- Add Category Form -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">Add New Category</h5>
                            <form id="categoryForm">
                                <div class="mb-3">
                                    <label for="categoryName" class="form-label">Category Name</label>
                                    <input type="text" class="form-control" id="categoryName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="categoryDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="categoryDescription" rows="3"></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">Add Category</button>
                            </form>
                        </div>
                    </div>

                    <!-- Categories List -->
                    <div id="categoriesList" class="row"></div>
                </div>

                <!-- Certifications Tab -->
                <div class="tab-pane fade" id="certifications" role="tabpanel">
                    <!-- Add Certification Form -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">Add New Certification</h5>
                            <form id="certificationForm">
                                <div class="mb-3">
                                    <label for="certificationName" class="form-label">Certification Name</label>
                                    <input type="text" class="form-control" id="certificationName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="certificationDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="certificationDescription" rows="3"></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">Add Certification</button>
                            </form>
                        </div>
                    </div>

                    <!-- Certifications List -->
                    <div id="allCertificationsDisplayList" class="row"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'http://localhost:8080/api';
        const BACKEND_URL = 'http://localhost:8080';

        // Helper function to fetch with authentication token
        async function fetchWithAuth(url, options = {}) {
            const token = localStorage.getItem('token');
            const headers = {
                ...(options.headers || {}),
            };

            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            // Special handling for FormData: fetch adds Content-Type automatically
            if (!(options.body instanceof FormData)) {
                // Default to JSON content type if not specified and body exists
                if (!headers['Content-Type'] && options.body) {
                    headers['Content-Type'] = 'application/json';
                }
            } else {
                // Remove Content-Type header if body is FormData, let the browser set it
                delete headers['Content-Type'];
            }

            const response = await fetch(url, {
                ...options,
                headers: headers
            });

            if (response.status === 401) {
                // Unauthorized: redirect to login or show message
                console.error('Authentication required. Redirecting to login.');
                // window.location.href = '/login.html'; // Optional: redirect
                throw new Error('Authentication failed. Please log in again.');
            }

            return response;
        }

        // Check authentication status
        async function checkAuthStatus() {
            const authStatusDiv = document.getElementById('authStatus');
            authStatusDiv.style.display = 'block';
            authStatusDiv.className = 'alert alert-info mb-3';
            authStatusDiv.textContent = 'Checking authentication status...';
            
            const token = localStorage.getItem('token');
            const authLinks = document.getElementById('authLinks');
            const logoutLink = document.getElementById('logoutLink');
            const orderManagementLink = document.getElementById('orderManagementLink');
            const addWorkerLink = document.getElementById('addWorkerLink');
            const productManagementLink = document.getElementById('productManagementLink');
            
            if (token) {
                // User is logged in
                authLinks.style.display = 'none';
                logoutLink.style.display = 'block';
                
                try {
                    // Decode JWT token
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    console.log('User roles:', payload.roles); // Debug log
                    
                    if (payload.roles && payload.roles.includes('ROLE_ADMIN')) {
                        // Admin has access to everything
                        orderManagementLink.style.display = 'block';
                        addWorkerLink.style.display = 'block';
                        productManagementLink.style.display = 'block';
                        authStatusDiv.className = 'alert alert-success mb-3';
                        authStatusDiv.innerHTML = `
                            <strong>Authenticated as Admin</strong><br>
                            Username: ${payload.sub}<br>
                            Roles: ${payload.roles.join(', ')}<br>
                            You have full access to all product management features.
                        `;
                        tryDirectImageUpdate();
                        // Load all product data after authentication
                        loadProducts();
                        loadCategories();
                        loadCertifications();
                    } else if (payload.roles && (payload.roles.includes('ROLE_PM') || payload.roles.includes('ROLE_PRODUCT_MANAGER'))) {
                        // Product Manager has access to product management and basic pages
                        orderManagementLink.style.display = 'none';
                        addWorkerLink.style.display = 'none';
                        productManagementLink.style.display = 'block';
                        authStatusDiv.className = 'alert alert-success mb-3';
                        authStatusDiv.innerHTML = `
                            <strong>Authenticated as Product Manager</strong><br>
                            Username: ${payload.sub}<br>
                            Roles: ${payload.roles.join(', ')}<br>
                            You have access to product management features.
                        `;
                        tryDirectImageUpdate();
                        // Load all product data after authentication
                        loadProducts();
                        loadCategories();
                        loadCertifications();
                    } else if (payload.roles && payload.roles.includes('ROLE_OM')) {
                        // Order Manager has access to order management only
                        orderManagementLink.style.display = 'block';
                        addWorkerLink.style.display = 'none';
                        productManagementLink.style.display = 'none';
                        authStatusDiv.className = 'alert alert-warning mb-3';
                        authStatusDiv.innerHTML = `
                            <strong>Insufficient Role</strong><br>
                            You are logged in as ${payload.sub} but do not have product management privileges.<br>
                            ROLE_ADMIN or ROLE_PM is required for product management.
                        `;
                    } else {
                        // Regular users have limited access
                        orderManagementLink.style.display = 'none';
                        addWorkerLink.style.display = 'none';
                        productManagementLink.style.display = 'none';
                        authStatusDiv.className = 'alert alert-warning mb-3';
                        authStatusDiv.innerHTML = `
                            <strong>Insufficient Role</strong><br>
                            You are logged in as ${payload.sub} but do not have product management privileges.<br>
                            ROLE_ADMIN or ROLE_PM is required for product management.
                        `;
                    }
                } catch (error) {
                    console.error("Error parsing JWT:", error);
                    authStatusDiv.className = 'alert alert-danger mb-3';
                    authStatusDiv.innerHTML = `
                        <strong>Authentication Error</strong><br>
                        Error: ${error.message}<br>
                        Please try logging in again.
                    `;
                }
            } else {
                // User is not logged in
                authLinks.style.display = 'block';
                logoutLink.style.display = 'none';
                orderManagementLink.style.display = 'none';
                addWorkerLink.style.display = 'none';
                productManagementLink.style.display = 'none';
                authStatusDiv.className = 'alert alert-warning mb-3';
                authStatusDiv.innerHTML = `
                    <strong>Authentication Required</strong><br>
                    Please log in to access product management features.
                `;
            }
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        }
        
        // Try alternative approaches to update images
        async function tryDirectImageUpdate() {
            // Do nothing for now, this will be used to test direct API calls if needed
            console.log("Ready to try direct image update if needed");
        }
        
        // Arrays to store temporary data
        let features = []; // array of strings
        let specifications = []; // array of {name: string, value: string} objects
        let certifications = []; // array of {id: number, name: string} objects
        let weightOptions = []; // array of {weightValue: number, price: number, packagingPhoto: File} objects
        let hasNutritionalInfo = false; // To track if nutritional info is enabled

        // Load all products
        async function loadProducts() {
            try {
                // Use fetchWithAuth
                const response = await fetchWithAuth(`${API_URL}/products`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const products = await response.json();
                const productsList = document.getElementById('productsList');
                productsList.innerHTML = '';
                
                products.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'col-md-4 mb-3';
                    productCard.innerHTML = `
                        <div class="card product-card">
                            <div class="position-relative">
                                <img src="${BACKEND_URL}/api/products/${product.id}/image" class="card-img-top product-image" alt="${product.name}">
                                <button class="btn btn-sm btn-primary position-absolute bottom-0 end-0 m-2" onclick="editProductPhoto(${product.id})">
                                    <i class="bi bi-pencil"></i> Edit Photo
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="card-title">${product.name}</h5>
                                    <button class="btn btn-sm btn-info" onclick="editProductBasicInfo(${product.id}, ${JSON.stringify(product).replace(/"/g, '&quot;')})">Edit Details</button>
                                </div>
                                <p class="card-text">${product.description || ''}</p>
                                <p class="card-text">
                                    <strong>Price:</strong> $${product.pricePerKg}/kg<br>
                                    <strong>Inventory:</strong> ${product.inventory}<br>
                                    ${product.hasDiscount ? `<strong>Discount:</strong> ${product.discountPercentage}%<br>` : ''}
                                    ${product.isNewArrival ? '<span class="badge bg-success">New Arrival</span> ' : ''}
                                    ${product.isBestSeller ? '<span class="badge bg-warning">Best Seller</span> ' : ''}
                                    ${product.isFeatured ? '<span class="badge bg-info">Featured</span>' : ''}
                                </p>
                                ${featuresHtml}
                                ${specificationsHtml}
                                ${certificationsHtml}
                                ${weightOptionsHtml}
                                ${nutritionalInfoHtml}
                                <div class="mt-3">
                                    <button class="btn btn-danger btn-sm me-2" onclick="deleteProduct(${product.id})">Delete</button>
                                </div>
                            </div>
                        </div>
                    `;
                    productsList.appendChild(productCard);
                });
            } catch (error) {
                console.error('Error loading products:', error);
                const productsList = document.getElementById('productsList');
                productsList.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger" role="alert">
                            Error loading products: ${error.message}
                        </div>
                    </div>
                `;
            }
        }

        // Load all categories
        async function loadCategories() {
            try {
                // Use fetchWithAuth
                const response = await fetchWithAuth(`${API_URL}/categories`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const categories = await response.json();
                const categoriesList = document.getElementById('categoriesList');
                const categorySelect = document.getElementById('categoryId');
                
                // Update categories list
                categoriesList.innerHTML = '';
                categorySelect.innerHTML = '<option value="">Select Category</option>';
                
                categories.forEach(category => {
                    // Add to select dropdown
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);

                    // Add to categories list
                    const categoryCard = document.createElement('div');
                    categoryCard.className = 'col-md-4 mb-3';
                    categoryCard.innerHTML = `
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">${category.name}</h5>
                                <p class="card-text">${category.description || ''}</p>
                                <button class="btn btn-danger" onclick="deleteCategory(${category.id})">Delete</button>
                            </div>
                        </div>
                    `;
                    categoriesList.appendChild(categoryCard);
                });
            } catch (error) {
                console.error('Error loading categories:', error);
                alert('Error loading categories: ' + error.message);
            }
        }

        // Load all certifications
        async function loadCertifications() {
            try {
                // Use fetchWithAuth
                const response = await fetchWithAuth(`${API_URL}/certifications`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const allCerts = await response.json();
                const allCertificationsDisplay = document.getElementById('allCertificationsDisplayList');
                const certificationSelectDropdown = document.getElementById('certificationSelect');
                
                // Update certifications display list in the Certifications Tab
                allCertificationsDisplay.innerHTML = ''; 
                certificationSelectDropdown.innerHTML = '<option value="">Select Certification</option>';
                
                allCerts.forEach(cert => {
                    // Add to select dropdown in Product Form
                    const option = document.createElement('option');
                    option.value = cert.id;
                    option.textContent = cert.name;
                    certificationSelectDropdown.appendChild(option);

                    // Add to certifications display list in Certifications Tab
                    const certCard = document.createElement('div');
                    certCard.className = 'col-md-4 mb-3';
                    certCard.innerHTML = `
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">${cert.name}</h5>
                                <p class="card-text">${cert.description || ''}</p>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-info btn-sm" onclick="editCertification(${cert.id}, '${cert.name.replace(/'/g, "\\'")}', '${(cert.description || '').replace(/'/g, "\\'")}')">Edit</button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteCertification(${cert.id})">Delete</button>
                                </div>
                            </div>
                        </div>
                    `;
                    allCertificationsDisplay.appendChild(certCard);
                });
            } catch (error) {
                console.error('Error loading certifications:', error);
                alert('Error loading certifications: ' + error.message);
            }
        }

        // Feature management
        function addFeature() {
            const featureInput = document.getElementById('featureInput');
            const feature = featureInput.value.trim();
            if (feature) {
                features.push(feature);
                updateFeaturesList();
                featureInput.value = '';
            }
        }

        function removeFeature(index) {
            features.splice(index, 1);
            updateFeaturesList();
        }

        function updateFeaturesList() {
            const featuresList = document.getElementById('featuresList');
            featuresList.innerHTML = features.map((feature, index) => `
                <div class="feature-item">
                    <span>${feature}</span>
                    <button class="btn btn-sm btn-danger" onclick="removeFeature(${index})">Remove</button>
                </div>
            `).join('');
        }

        // Specification management
        function addSpecification() {
            const specName = document.getElementById('specNameInput').value.trim();
            const specValue = document.getElementById('specValueInput').value.trim();
            if (specName && specValue) {
                specifications.push({ name: specName, value: specValue });
                updateSpecificationsList();
                document.getElementById('specNameInput').value = '';
                document.getElementById('specValueInput').value = '';
            }
        }

        function removeSpecification(index) {
            specifications.splice(index, 1);
            updateSpecificationsList();
        }

        function updateSpecificationsList() {
            const specificationsList = document.getElementById('specificationsList');
            specificationsList.innerHTML = specifications.map((spec, index) => `
                <div class="spec-item">
                    <span><strong>${spec.name}:</strong> ${spec.value}</span>
                    <button class="btn btn-sm btn-danger" onclick="removeSpecification(${index})">Remove</button>
                </div>
            `).join('');
        }

        // Certification management
        function addCertification() {
            const select = document.getElementById('certificationSelect');
            const certId = select.value;
            const certName = select.options[select.selectedIndex].text;
            if (certId && !certifications.some(cert => cert.id === certId)) {
                certifications.push({ id: certId, name: certName });
                updateCertificationsList();
            }
        }

        function removeCertification(index) {
            certifications.splice(index, 1);
            updateCertificationsList();
        }

        function updateCertificationsList() {
            const selectedProductCertList = document.getElementById('selectedProductCertificationsList');
            selectedProductCertList.innerHTML = certifications.map((cert, index) => {
                return `
                    <div class="cert-item">
                        <span>${cert.name}</span>
                        <button class="btn btn-sm btn-danger" onclick="removeCertification(${index})">Remove</button>
                    </div>
                `;
            }).join('');
        }

        // Weight Options management
        function addWeightOption() {
            const weightValue = document.getElementById('weightValueInput').value.trim();
            const price = document.getElementById('weightPriceInput').value.trim();
            const packagingPhoto = document.getElementById('packagingPhotoInput').files[0];
            
            if (weightValue && price) {
                weightOptions.push({
                    weightValue: parseInt(weightValue),
                    price: parseFloat(price),
                    packagingPhoto: packagingPhoto
                });
                updateWeightOptionsList();
                document.getElementById('weightValueInput').value = '';
                document.getElementById('weightPriceInput').value = '';
                document.getElementById('packagingPhotoInput').value = '';
            }
        }

        function removeWeightOption(index) {
            weightOptions.splice(index, 1);
            updateWeightOptionsList();
        }

        function updateWeightOptionsList() {
            const weightOptionsList = document.getElementById('weightOptionsList');
            weightOptionsList.innerHTML = weightOptions.map((option, index) => `
                <div class="weight-option-item">
                    <span><strong>${option.weightValue}g:</strong> $${option.price} ${option.packagingPhoto ? '(with packaging photo)' : ''}</span>
                    <button class="btn btn-sm btn-danger" onclick="removeWeightOption(${index})">Remove</button>
                </div>
            `).join('');
        }

        // Toggle nutritional info form
        function toggleNutritionalInfoForm() {
            const hasNutritionalInfoCheckbox = document.getElementById('hasNutritionalInfo');
            const nutritionalInfoForm = document.getElementById('nutritionalInfoForm');
            
            hasNutritionalInfo = hasNutritionalInfoCheckbox.checked;
            nutritionalInfoForm.style.display = hasNutritionalInfo ? 'block' : 'none';
        }

        // Reset the product form to its initial state
        function resetProductForm() {
            document.getElementById('productForm').reset();
            features = [];
            specifications = [];
            certifications = [];
            weightOptions = [];
            hasNutritionalInfo = false;
            
            updateFeaturesList();
            updateSpecificationsList();
            updateCertificationsList();
            updateWeightOptionsList();
            
            document.getElementById('nutritionalInfoForm').style.display = 'none';
            document.getElementById('hasNutritionalInfo').checked = false;
            
            // Reset form title and button text
            document.querySelector('#productForm').parentNode.querySelector('.card-title').textContent = 'Add New Product';
            document.getElementById('submitProductBtn').textContent = 'Add Product';
            
            // Clear file inputs explicitly as reset() might not clear them
            document.getElementById('productImage').value = '';
            document.getElementById('packagingPhotoInput').value = '';
        }

        // Add new product
        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // --- Gather Data --- 
            const name = document.getElementById('name').value;
            const description = document.getElementById('description').value;
            const categoryId = document.getElementById('categoryId').value;
            const pricePerKg = document.getElementById('pricePerKg').value;
            const inventory = document.getElementById('inventory').value;
            const isNewArrival = document.getElementById('isNewArrival').checked;
            const isBestSeller = document.getElementById('isBestSeller').checked;
            const isFeatured = document.getElementById('isFeatured').checked;
            const hasDiscount = document.getElementById('hasDiscount').checked;
            const discountPercentage = document.getElementById('discountPercentage').value || '0';
            const productImageFile = document.getElementById('productImage').files[0];

            // Gather features (array of strings)
            const currentFeatures = features; // features array holds strings

            // Gather specifications (array of {specName: string, specValue: string})
            const currentSpecifications = specifications.map(s => ({ specName: s.name, specValue: s.value }));

            // Gather certifications (array of numbers/longs - the IDs)
            const currentCertificationIds = certifications.map(c => parseInt(c.id));

            // Gather weight options (array of {weightValue: string, price: number, packagingPhoto: string/url})
            const currentWeightOptions = weightOptions.map(wo => ({
                weightValue: String(wo.weightValue), // Convert to string
                price: wo.price,
                packagingPhoto: null
            }));

            // Store if we have nutritional info
            const hasNutritionalInfoData = hasNutritionalInfo;

            try {
                // --- Prepare for POST (Create) ---
                const method = 'POST';
                const url = `${API_URL}/products`;
                const successMessage = 'Product added successfully!';
                // Use FormData for POST to include the image
                const formData = new FormData();
                formData.append('name', name);
                formData.append('description', description);
                if (categoryId) formData.append('categoryId', categoryId);
                formData.append('pricePerKg', pricePerKg);
                formData.append('inventory', inventory);
                formData.append('isNewArrival', isNewArrival);
                formData.append('isBestSeller', isBestSeller);
                formData.append('isFeatured', isFeatured);
                formData.append('hasDiscount', hasDiscount);
                formData.append('discountPercentage', discountPercentage);
                if (productImageFile) {
                     formData.append('image', productImageFile);
                }
                const body = formData;
                
                // Use fetchWithAuth for product creation
                let response = await fetchWithAuth(url, {
                    method: method,
                    body: body 
                });
                
                if (!response.ok) {
                    const errorData = await response.text(); // Read error as text
                    console.error('Server Response Error:', errorData);
                    try {
                        const parsedError = JSON.parse(errorData); 
                        throw new Error(parsedError.message || JSON.stringify(parsedError));
                    } catch (parseError) {
                        throw new Error(errorData || `HTTP error! status: ${response.status}`);
                    }
                }
                
                const savedProduct = await response.json();
                const productId = savedProduct.id;
                
                console.log("Created new product with ID:", productId);
                console.log("Product details:", savedProduct);
                
                // Verify the product exists by fetching it back
                try {
                    const verifyResponse = await fetchWithAuth(`${API_URL}/products/admin/${productId}`);
                    if (verifyResponse.ok) {
                        console.log("Successfully verified product exists:", await verifyResponse.json());
                    } else {
                        console.error("Could not verify product exists, status:", verifyResponse.status);
                    }
                } catch (verifyError) {
                    console.error("Error verifying product exists:", verifyError);
                }

                // --- Logic for Adding Related Entities ---
                console.log("Adding related entities for new product:", productId);
                
                // Add features
                for (const feature of currentFeatures) {
                    await fetchWithAuth(`${API_URL}/products/${productId}/features`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, 
                        body: `feature=${encodeURIComponent(feature)}`
                    });
                }
                
                // Add specifications
                for (const spec of currentSpecifications) {
                    await fetchWithAuth(`${API_URL}/products/${productId}/specifications`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, 
                        body: `specName=${encodeURIComponent(spec.specName)}&specValue=${encodeURIComponent(spec.specValue)}`
                    });
                }

                // Add certifications
                for (const certId of currentCertificationIds) {
                    await fetchWithAuth(`${API_URL}/products/${productId}/certifications/${certId}`, {
                        method: 'POST'
                    });
                }

                // Add weight options (handle packaging photo upload)
                for (const option of weightOptions) {
                   const weightOptionFormData = new FormData();
                   weightOptionFormData.append('weightValue', option.weightValue);
                   weightOptionFormData.append('price', option.price);
                   if (option.packagingPhoto instanceof File) {
                       weightOptionFormData.append('packagingImage', option.packagingPhoto);
                   }
                   
                   const optionResponse = await fetchWithAuth(`${API_URL}/products/${productId}/weight-options`, {
                       method: 'POST',
                       body: weightOptionFormData
                   });
                   if (!optionResponse.ok) console.error('Failed to save new weight option');
                }

                // Add nutritional info if specified
                if (hasNutritionalInfoData) {
                    // Create nutritional info object now that we have the productId
                    const nutritionalInfoData = {
                        // Only include nutritional data fields without any ID or product reference
                        servingSize: document.getElementById('servingSize').value || null,
                        servingsPerContainer: document.getElementById('servingsPerContainer').value || null,
                        calories: document.getElementById('calories').value || null,
                        totalFat: document.getElementById('totalFat').value || null,
                        saturatedFat: document.getElementById('saturatedFat').value || null,
                        transFat: document.getElementById('transFat').value || null,
                        cholesterol: document.getElementById('cholesterol').value || null,
                        sodium: document.getElementById('sodium').value || null,
                        totalCarbohydrates: document.getElementById('totalCarbohydrates').value || null,
                        dietaryFiber: document.getElementById('dietaryFiber').value || null,
                        sugars: document.getElementById('sugars').value || null,
                        protein: document.getElementById('protein').value || null,
                        vitaminA: document.getElementById('vitaminA').value || null,
                        vitaminC: document.getElementById('vitaminC').value || null,
                        calcium: document.getElementById('calcium').value || null,
                        iron: document.getElementById('iron').value || null
                    };
                    
                    console.log('Sending nutritional info data:', JSON.stringify(nutritionalInfoData, null, 2));
                    console.log('Sending to URL:', `${API_URL}/products/${productId}/nutritional-info`);
                    
                    const nutritionalInfoResponse = await fetchWithAuth(`${API_URL}/products/${productId}/nutritional-info`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(nutritionalInfoData)
                    });
                    
                    if (!nutritionalInfoResponse.ok) {
                        const errorData = await nutritionalInfoResponse.text();
                        console.error('Failed to save nutritional info:', errorData);
                        console.error('Response status:', nutritionalInfoResponse.status);
                        console.error('Response headers:', [...nutritionalInfoResponse.headers.entries()]);
                        
                        try {
                            const parsedError = JSON.parse(errorData);
                            console.error('Parsed error details:', parsedError);
                            throw new Error(`Failed to save nutritional information: ${parsedError.error || parsedError.message || 'Unknown error'}`);
                        } catch (parseError) {
                            // If we can't parse the error as JSON, use it as is
                            throw new Error(`Failed to save nutritional information: ${errorData}`);
                        }
                    }
                }
                
                // Display success message
                alert(successMessage);
                resetProductForm();
                
                // Refresh products list
                await loadProducts();
                
                // Check if we need to update the featured products
                if (isNewArrival || isBestSeller || isFeatured) {
                    await fetchWithAuth(`${API_URL}/products/featured`, {
                        method: 'POST'
                    });
                }
            } catch (error) {
                console.error('Error saving product:', error);
                alert('Error saving product: ' + error.message);
            }
        });

        // Add new category
        document.getElementById('categoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const categoryData = {
                name: document.getElementById('categoryName').value,
                description: document.getElementById('categoryDescription').value
            };

            try {
                // Use fetchWithAuth
                await fetchWithAuth(`${API_URL}/categories`, {
                    method: 'POST',
                    // fetchWithAuth sets Content-Type
                    body: JSON.stringify(categoryData)
                });
                document.getElementById('categoryForm').reset();
                loadCategories();
            } catch (error) {
                console.error('Error adding category:', error);
            }
        });

        // Delete product
        async function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product?')) {
                try {
                    // Use fetchWithAuth
                    const response = await fetchWithAuth(`${API_URL}/products/${id}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.text();
                        throw new Error(errorData || 'Failed to delete product');
                    }
                    
                    // Show success message
                    alert('Product deleted successfully');
                    
                    // Reload the products list
                    await loadProducts();
                } catch (error) {
                    console.error('Error deleting product:', error);
                    alert('Error deleting product: ' + error.message);
                }
            }
        }

        // Delete category
        async function deleteCategory(id) {
            if (confirm('Are you sure you want to delete this category?')) {
                try {
                    // Use fetchWithAuth
                    const response = await fetchWithAuth(`${API_URL}/categories/${id}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.text();
                        throw new Error(errorData || 'Failed to delete category');
                    }
                    
                    // Show success message
                    alert('Category deleted successfully');
                    
                    // Reload the categories list
                    await loadCategories();
                } catch (error) {
                    console.error('Error deleting category:', error);
                    alert('Error deleting category: ' + error.message);
                }
            }
        }

        // Delete certification
        async function deleteCertification(id) {
            if (confirm('Are you sure you want to delete this certification?')) {
                try {
                    // Use fetchWithAuth
                    const response = await fetchWithAuth(`${API_URL}/certifications/${id}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.text();
                        throw new Error(errorData || 'Failed to delete certification');
                    }
                    
                    // Show success message
                    alert('Certification deleted successfully');
                    
                    // Reload the certifications list
                    await loadCertifications();
                } catch (error) {
                    console.error('Error deleting certification:', error);
                    alert('Error deleting certification: ' + error.message);
                }
            }
        }

        // Edit weight option photo
        async function editWeightOptionPhoto(productId, optionId) {
            // Create a file input element
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            
            // When a file is selected, upload it
            fileInput.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const formData = new FormData();
                    formData.append('packagingImage', file);
                    
                    const response = await fetchWithAuth(`${API_URL}/products/${productId}/weight-options/${optionId}/update-image`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.text();
                        throw new Error(errorData || 'Failed to update weight option photo');
                    }
                    
                    // Show success message
                    alert('Weight option photo updated successfully');
                    
                    // Reload the products to show the updated photo
                    await loadProducts();
                } catch (error) {
                    console.error('Error updating weight option photo:', error);
                    alert('Error updating weight option photo: ' + error.message);
                }
            };
            
            // Trigger the file selection dialog
            fileInput.click();
        }

        // Edit weight option information (weight and price)
        async function editWeightOptionInfo(productId, optionId, currentWeight, currentPrice) {
            // Create a modal for editing weight option info
            const modalId = 'editWeightOptionInfoModal';
            let modal = document.getElementById(modalId);
            
            // Remove existing modal if it exists
            if (modal) {
                document.body.removeChild(modal);
            }
            
            // Create new modal
            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal fade';
            modal.tabIndex = '-1';
            modal.role = 'dialog';
            modal.setAttribute('aria-hidden', 'true');
            
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Weight Option</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editWeightOptionForm">
                                <div class="mb-3">
                                    <label for="editWeightValue" class="form-label">Weight (grams)</label>
                                    <input type="number" class="form-control" id="editWeightValue" value="${currentWeight}" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editWeightPrice" class="form-label">Price</label>
                                    <input type="number" class="form-control" id="editWeightPrice" step="0.01" value="${currentPrice}" required>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="saveWeightOptionInfo">Save Changes</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Initialize the Bootstrap modal
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
            
            // Handle save button click
            document.getElementById('saveWeightOptionInfo').addEventListener('click', async () => {
                const weightValue = document.getElementById('editWeightValue').value;
                const price = document.getElementById('editWeightPrice').value;
                
                if (!weightValue || !price) {
                    alert('Please fill in all required fields');
                    return;
                }
                
                try {
                    // Create a JSON object with the updated information
                    const updatedData = {
                        weightValue: parseInt(weightValue),
                        price: parseFloat(price)
                    };
                    
                    const response = await fetchWithAuth(`${API_URL}/products/${productId}/weight-options/${optionId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updatedData)
                    });
                    
                    if (!response.ok) {
                        // If the PUT endpoint doesn't exist or fails, try with a POST request to a different endpoint
                        // as a fallback option
                        if (response.status === 404 || response.status === 405) {
                            const fallbackResponse = await fetchWithAuth(`${API_URL}/products/${productId}/weight-options/${optionId}/update-info`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(updatedData)
                            });
                            
                            if (!fallbackResponse.ok) {
                                const errorData = await fallbackResponse.text();
                                throw new Error(errorData || 'Failed to update weight option information');
                            }
                        } else {
                            const errorData = await response.text();
                            throw new Error(errorData || 'Failed to update weight option information');
                        }
                    }
                    
                    // Show success message
                    alert('Weight option information updated successfully');
                    
                    // Close the modal
                    bootstrapModal.hide();
                    
                    // Reload the products to show the updated weight options
                    await loadProducts();
                } catch (error) {
                    console.error('Error updating weight option information:', error);
                    alert('Error updating weight option information: ' + error.message);
                }
            });
        }

        // Delete weight option
        async function deleteWeightOption(productId, optionId) {
            if (confirm('Are you sure you want to delete this weight option?')) {
                try {
                    const response = await fetchWithAuth(`${API_URL}/products/weight-options/${optionId}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.text();
                        throw new Error(errorData || 'Failed to delete weight option');
                    }
                    
                    // Show success message
                    alert('Weight option deleted successfully');
                    
                    // Reload the products to show the updated weight options
                    await loadProducts();
                } catch (error) {
                    console.error('Error deleting weight option:', error);
                    alert('Error deleting weight option: ' + error.message);
                }
            }
        }

        // Add more weight options to an existing product
        async function addMoreWeightOptions(productId) {
            // Create a modal for adding a new weight option
            const modalId = 'addWeightOptionModal';
            let modal = document.getElementById(modalId);
            
            // Remove existing modal if it exists
            if (modal) {
                document.body.removeChild(modal);
            }
            
            // Create new modal
            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal fade';
            modal.tabIndex = '-1';
            modal.role = 'dialog';
            modal.setAttribute('aria-hidden', 'true');
            
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add New Weight Option</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="newWeightOptionForm">
                                <div class="mb-3">
                                    <label for="newWeightValue" class="form-label">Weight (grams)</label>
                                    <input type="number" class="form-control" id="newWeightValue" required>
                                </div>
                                <div class="mb-3">
                                    <label for="newWeightPrice" class="form-label">Price</label>
                                    <input type="number" class="form-control" id="newWeightPrice" step="0.01" required>
                                </div>
                                <div class="mb-3">
                                    <label for="newPackagingPhoto" class="form-label">Packaging Photo</label>
                                    <input type="file" class="form-control" id="newPackagingPhoto" accept="image/*">
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="saveNewWeightOption">Save</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Initialize the Bootstrap modal
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
            
            // Handle save button click
            document.getElementById('saveNewWeightOption').addEventListener('click', async () => {
                const weightValue = document.getElementById('newWeightValue').value;
                const price = document.getElementById('newWeightPrice').value;
                const packagingPhoto = document.getElementById('newPackagingPhoto').files[0];
                
                if (!weightValue || !price) {
                    alert('Please fill in all required fields');
                    return;
                }
                
                try {
                    const formData = new FormData();
                    formData.append('weightValue', weightValue);
                    formData.append('price', price);
                    if (packagingPhoto) {
                        formData.append('packagingImage', packagingPhoto);
                    }
                    
                    const response = await fetchWithAuth(`${API_URL}/products/${productId}/weight-options`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.text();
                        throw new Error(errorData || 'Failed to add new weight option');
                    }
                    
                    // Show success message
                    alert('New weight option added successfully');
                    
                    // Close the modal
                    bootstrapModal.hide();
                    
                    // Reload the products to show the updated weight options
                    await loadProducts();
                } catch (error) {
                    console.error('Error adding new weight option:', error);
                    alert('Error adding new weight option: ' + error.message);
                }
            });
        }

        // Edit product main photo
        async function editProductPhoto(productId) {
            // Create a file input element
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            
            // When a file is selected, upload it
            fileInput.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const formData = new FormData();
                    formData.append('image', file);
                    
                    const response = await fetchWithAuth(`${API_URL}/products/${productId}/update-image`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.text();
                        throw new Error(errorData || 'Failed to update product photo');
                    }
                    
                    // Show success message
                    alert('Product photo updated successfully');
                    
                    // Reload the products to show the updated photo
                    await loadProducts();
                } catch (error) {
                    console.error('Error updating product photo:', error);
                    alert('Error updating product photo: ' + error.message);
                }
            };
            
            // Trigger the file selection dialog
            fileInput.click();
        }

        // Edit nutritional information
        async function editNutritionalInfo(productId) {
            // Fetch current nutritional info
            try {
                const response = await fetchWithAuth(`${API_URL}/products/${productId}/nutritional-info`);
                let nutritionalInfo = {};
                
                if (response.ok) {
                    nutritionalInfo = await response.json();
                }
                
                // Create a modal for editing nutritional info
                const modalId = 'editNutritionalInfoModal';
                let modal = document.getElementById(modalId);
                
                // Remove existing modal if it exists
                if (modal) {
                    document.body.removeChild(modal);
                }
                
                // Create new modal
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'modal fade';
                modal.tabIndex = '-1';
                modal.role = 'dialog';
                modal.setAttribute('aria-hidden', 'true');
                
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Edit Nutritional Information</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="editNutritionalInfoForm">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="editServingSize" class="form-label">Serving Size</label>
                                            <input type="text" class="form-control" id="editServingSize" value="${nutritionalInfo.servingSize || ''}">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="editServingsPerContainer" class="form-label">Servings Per Container</label>
                                            <input type="text" class="form-control" id="editServingsPerContainer" value="${nutritionalInfo.servingsPerContainer || ''}">
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="editCalories" class="form-label">Calories</label>
                                                <input type="text" class="form-control" id="editCalories" value="${nutritionalInfo.calories || ''}">
                                            </div>
                                            <div class="mb-3">
                                                <label for="editTotalFat" class="form-label">Total Fat</label>
                                                <input type="text" class="form-control" id="editTotalFat" value="${nutritionalInfo.totalFat || ''}">
                                            </div>
                                            <div class="mb-3">
                                                <label for="editSaturatedFat" class="form-label">Saturated Fat</label>
                                                <input type="text" class="form-control" id="editSaturatedFat" value="${nutritionalInfo.saturatedFat || ''}">
                                            </div>
                                            <div class="mb-3">
                                                <label for="editTransFat" class="form-label">Trans Fat</label>
                                                <input type="text" class="form-control" id="editTransFat" value="${nutritionalInfo.transFat || ''}">
                                            </div>
                                            <div class="mb-3">
                                                <label for="editCholesterol" class="form-label">Cholesterol</label>
                                                <input type="text" class="form-control" id="editCholesterol" value="${nutritionalInfo.cholesterol || ''}">
                                            </div>
                                            <div class="mb-3">
                                                <label for="editSodium" class="form-label">Sodium</label>
                                                <input type="text" class="form-control" id="editSodium" value="${nutritionalInfo.sodium || ''}">
                                            </div>
                                            <div class="mb-3">
                                                <label for="editTotalCarbohydrates" class="form-label">Total Carbohydrates</label>
                                                <input type="text" class="form-control" id="editTotalCarbohydrates" value="${nutritionalInfo.totalCarbohydrates || ''}">
                                            </div>
                                            <div class="mb-3">
                                                <label for="editDietaryFiber" class="form-label">Dietary Fiber</label>
                                                <input type="text" class="form-control" id="editDietaryFiber" value="${nutritionalInfo.dietaryFiber || ''}">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="editSugars" class="form-label">Sugars</label>
                                                <input type="text" class="form-control" id="editSugars" value="${nutritionalInfo.sugars || ''}">
                                            </div>
                                            <div class="mb-3">
                                                <label for="editProtein" class="form-label">Protein</label>
                                                <input type="text" class="form-control" id="editProtein" value="${nutritionalInfo.protein || ''}">
                                            </div>
                                            <div class="mb-3">
                                                <label for="editVitaminA" class="form-label">Vitamin A</label>
                                                <input type="text" class="form-control" id="editVitaminA" value="${nutritionalInfo.vitaminA || ''}">
                                            </div>
                                            <div class="mb-3">
                                                <label for="editVitaminC" class="form-label">Vitamin C</label>
                                                <input type="text" class="form-control" id="editVitaminC" value="${nutritionalInfo.vitaminC || ''}">
                                            </div>
                                            <div class="mb-3">
                                                <label for="editCalcium" class="form-label">Calcium</label>
                                                <input type="text" class="form-control" id="editCalcium" value="${nutritionalInfo.calcium || ''}">
                                            </div>
                                            <div class="mb-3">
                                                <label for="editIron" class="form-label">Iron</label>
                                                <input type="text" class="form-control" id="editIron" value="${nutritionalInfo.iron || ''}">
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="saveNutritionalInfo">Save Changes</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Initialize the Bootstrap modal
                const bootstrapModal = new bootstrap.Modal(modal);
                bootstrapModal.show();
                
                // Handle save button click
                document.getElementById('saveNutritionalInfo').addEventListener('click', async () => {
                    // Collect all nutritional info data
                    const updatedNutritionalInfo = {
                        servingSize: document.getElementById('editServingSize').value || null,
                        servingsPerContainer: document.getElementById('editServingsPerContainer').value || null,
                        calories: document.getElementById('editCalories').value || null,
                        totalFat: document.getElementById('editTotalFat').value || null,
                        saturatedFat: document.getElementById('editSaturatedFat').value || null,
                        transFat: document.getElementById('editTransFat').value || null,
                        cholesterol: document.getElementById('editCholesterol').value || null,
                        sodium: document.getElementById('editSodium').value || null,
                        totalCarbohydrates: document.getElementById('editTotalCarbohydrates').value || null,
                        dietaryFiber: document.getElementById('editDietaryFiber').value || null,
                        sugars: document.getElementById('editSugars').value || null,
                        protein: document.getElementById('editProtein').value || null,
                        vitaminA: document.getElementById('editVitaminA').value || null,
                        vitaminC: document.getElementById('editVitaminC').value || null,
                        calcium: document.getElementById('editCalcium').value || null,
                        iron: document.getElementById('editIron').value || null
                    };
                    
                    try {
                        const response = await fetchWithAuth(`${API_URL}/products/${productId}/nutritional-info`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(updatedNutritionalInfo)
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.text();
                            throw new Error(errorData || 'Failed to update nutritional information');
                        }
                        
                        // Show success message
                        alert('Nutritional information updated successfully');
                        
                        // Close the modal
                        bootstrapModal.hide();
                        
                        // Reload the products to show the updated nutritional info
                        await loadProducts();
                    } catch (error) {
                        console.error('Error updating nutritional information:', error);
                        alert('Error updating nutritional information: ' + error.message);
                    }
                });
            } catch (error) {
                console.error('Error loading nutritional information:', error);
                alert('Error loading nutritional information: ' + error.message);
            }
        }

        // Edit feature
        async function editFeature(productId, featureId, currentFeature) {
            // Create a modal for editing feature
            const modalId = 'editFeatureModal';
            let modal = document.getElementById(modalId);
            
            // Remove existing modal if it exists
            if (modal) {
                document.body.removeChild(modal);
            }
            
            // Create new modal
            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal fade';
            modal.tabIndex = '-1';
            modal.role = 'dialog';
            modal.setAttribute('aria-hidden', 'true');
            
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Feature</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editFeatureForm">
                                <div class="mb-3">
                                    <label for="editFeatureText" class="form-label">Feature</label>
                                    <input type="text" class="form-control" id="editFeatureText" value="${currentFeature.replace(/"/g, '&quot;')}" required>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="saveFeature">Save Changes</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Initialize the Bootstrap modal
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
            
            // Handle save button click
            document.getElementById('saveFeature').addEventListener('click', async () => {
                const feature = document.getElementById('editFeatureText').value.trim();
                
                if (!feature) {
                    alert('Please enter a feature');
                    return;
                }
                
                try {
                    // Try PUT first
                    const response = await fetchWithAuth(`${API_URL}/products/features/${featureId}?feature=${encodeURIComponent(feature)}`, {
                        method: 'PUT'
                    });
                    
                    if (!response.ok) {
                        // If PUT fails, try POST as fallback
                        if (response.status === 404 || response.status === 405) {
                            const fallbackResponse = await fetchWithAuth(`${API_URL}/products/features/${featureId}/update?feature=${encodeURIComponent(feature)}`, {
                                method: 'POST'
                            });
                            
                            if (!fallbackResponse.ok) {
                                const errorData = await fallbackResponse.text();
                                throw new Error(errorData || 'Failed to update feature');
                            }
                        } else {
                            const errorData = await response.text();
                            throw new Error(errorData || 'Failed to update feature');
                        }
                    }
                    
                    // Show success message
                    alert('Feature updated successfully');
                    
                    // Close the modal
                    bootstrapModal.hide();
                    
                    // Reload the products to show the updated features
                    await loadProducts();
                } catch (error) {
                    console.error('Error updating feature:', error);
                    alert('Error updating feature: ' + error.message);
                }
            });
        }

        // Delete feature
        async function deleteFeature(productId, featureId) {
            if (confirm('Are you sure you want to delete this feature?')) {
                try {
                    const response = await fetchWithAuth(`${API_URL}/products/features/${featureId}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.text();
                        throw new Error(errorData || 'Failed to delete feature');
                    }
                    
                    // Show success message
                    alert('Feature deleted successfully');
                    
                    // Reload the products to show the updated features
                    await loadProducts();
                } catch (error) {
                    console.error('Error deleting feature:', error);
                    alert('Error deleting feature: ' + error.message);
                }
            }
        }

        // Add more features to an existing product
        async function addMoreFeatures(productId) {
            // Create a modal for adding new features
            const modalId = 'addFeaturesModal';
            let modal = document.getElementById(modalId);
            
            // Remove existing modal if it exists
            if (modal) {
                document.body.removeChild(modal);
            }
            
            // Create new modal
            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal fade';
            modal.tabIndex = '-1';
            modal.role = 'dialog';
            modal.setAttribute('aria-hidden', 'true');
            
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add New Feature</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="newFeatureForm">
                                <div class="mb-3">
                                    <label for="newFeatureText" class="form-label">Feature</label>
                                    <input type="text" class="form-control" id="newFeatureText" required>
                                </div>
                                <div id="addedFeaturesList" class="mt-3"></div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeFeatureModal">Close</button>
                            <button type="button" class="btn btn-primary" id="addNewFeature">Add Feature</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Initialize the Bootstrap modal
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
            
            // Track added features in this session
            const addedFeatures = [];
            const updateAddedFeaturesList = () => {
                const listElement = document.getElementById('addedFeaturesList');
                const closeButton = document.getElementById('closeFeatureModal');
                
                if (addedFeatures.length === 0) {
                    listElement.innerHTML = '';
                    // Change button text to "Close" if no features added
                    if (closeButton) {
                        closeButton.textContent = 'Close';
                    }
                    return;
                }
                
                // Change button text to "Save" if features were added
                if (closeButton) {
                    closeButton.textContent = 'Save';
                    closeButton.classList.remove('btn-secondary');
                    closeButton.classList.add('btn-success');
                }
                
                listElement.innerHTML = `
                    <h6>Added Features:</h6>
                    <ul class="list-group">
                        ${addedFeatures.map(feature => `<li class="list-group-item">${feature}</li>`).join('')}
                    </ul>
                `;
            };
            
            // Handle add button click
            document.getElementById('addNewFeature').addEventListener('click', async () => {
                const feature = document.getElementById('newFeatureText').value.trim();
                
                if (!feature) {
                    alert('Please enter a feature');
                    return;
                }
                
                try {
                    const response = await fetchWithAuth(`${API_URL}/products/${productId}/features?feature=${encodeURIComponent(feature)}`, {
                        method: 'POST'
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.text();
                        throw new Error(errorData || 'Failed to add feature');
                    }
                    
                    // Add to the list of added features
                    addedFeatures.push(feature);
                    updateAddedFeaturesList();
                    
                    // Clear the input for next feature
                    document.getElementById('newFeatureText').value = '';
                    
                } catch (error) {
                    console.error('Error adding feature:', error);
                    alert('Error adding feature: ' + error.message);
                }
            });
            
            // Handle modal close - reload products
            modal.addEventListener('hidden.bs.modal', async () => {
                if (addedFeatures.length > 0) {
                    await loadProducts();
                }
            });
        }

        // Add new certification
        document.getElementById('certificationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const certificationData = {
                name: document.getElementById('certificationName').value,
                description: document.getElementById('certificationDescription').value
            };

            try {
                // Use fetchWithAuth
                await fetchWithAuth(`${API_URL}/certifications`, {
                    method: 'POST',
                    // fetchWithAuth sets Content-Type
                    body: JSON.stringify(certificationData)
                });
                document.getElementById('certificationForm').reset();
                loadCertifications();
            } catch (error) {
                console.error('Error adding certification:', error);
            }
        });

        // Load initial data
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
        });

        // Edit specification
        async function editSpecification(productId, specificationId, currentSpecName, currentSpecValue) {
            // Create a modal for editing specification
            const modalId = 'editSpecificationModal';
            let modal = document.getElementById(modalId);
            
            // Remove existing modal if it exists
            if (modal) {
                document.body.removeChild(modal);
            }
            
            // Create new modal
            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal fade';
            modal.tabIndex = '-1';
            modal.role = 'dialog';
            modal.setAttribute('aria-hidden', 'true');
            
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Specification</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editSpecificationForm">
                                <div class="mb-3">
                                    <label for="editSpecName" class="form-label">Specification Name</label>
                                    <input type="text" class="form-control" id="editSpecName" value="${currentSpecName.replace(/"/g, '&quot;')}" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editSpecValue" class="form-label">Specification Value</label>
                                    <input type="text" class="form-control" id="editSpecValue" value="${currentSpecValue.replace(/"/g, '&quot;')}" required>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="saveSpecification">Save Changes</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Initialize the Bootstrap modal
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
            
            // Handle save button click
            document.getElementById('saveSpecification').addEventListener('click', async () => {
                const specName = document.getElementById('editSpecName').value.trim();
                const specValue = document.getElementById('editSpecValue').value.trim();
                
                if (!specName || !specValue) {
                    alert('Please fill in all required fields');
                    return;
                }
                
                try {
                    // Try PUT first
                    const response = await fetchWithAuth(`${API_URL}/products/specifications/${specificationId}?specName=${encodeURIComponent(specName)}&specValue=${encodeURIComponent(specValue)}`, {
                        method: 'PUT'
                    });
                    
                    if (!response.ok) {
                        // If PUT fails, try POST as fallback
                        if (response.status === 404 || response.status === 405) {
                            const fallbackResponse = await fetchWithAuth(`${API_URL}/products/specifications/${specificationId}/update?specName=${encodeURIComponent(specName)}&specValue=${encodeURIComponent(specValue)}`, {
                                method: 'POST'
                            });
                            
                            if (!fallbackResponse.ok) {
                                const errorData = await fallbackResponse.text();
                                throw new Error(errorData || 'Failed to update specification');
                            }
                        } else {
                            const errorData = await response.text();
                            throw new Error(errorData || 'Failed to update specification');
                        }
                    }
                    
                    // Show success message
                    alert('Specification updated successfully');
                    
                    // Close the modal
                    bootstrapModal.hide();
                    
                    // Reload the products to show the updated specifications
                    await loadProducts();
                } catch (error) {
                    console.error('Error updating specification:', error);
                    alert('Error updating specification: ' + error.message);
                }
            });
        }

        // Delete specification
        async function deleteSpecification(productId, specificationId) {
            if (confirm('Are you sure you want to delete this specification?')) {
                try {
                    const response = await fetchWithAuth(`${API_URL}/products/specifications/${specificationId}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.text();
                        throw new Error(errorData || 'Failed to delete specification');
                    }
                    
                    // Show success message
                    alert('Specification deleted successfully');
                    
                    // Reload the products to show the updated specifications
                    await loadProducts();
                } catch (error) {
                    console.error('Error deleting specification:', error);
                    alert('Error deleting specification: ' + error.message);
                }
            }
        }

        // Add more specifications to an existing product
        async function addMoreSpecifications(productId) {
            // Create a modal for adding new specifications
            const modalId = 'addSpecificationsModal';
            let modal = document.getElementById(modalId);
            
            // Remove existing modal if it exists
            if (modal) {
                document.body.removeChild(modal);
            }
            
            // Create new modal
            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal fade';
            modal.tabIndex = '-1';
            modal.role = 'dialog';
            modal.setAttribute('aria-hidden', 'true');
            
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add New Specification</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="newSpecificationForm">
                                <div class="mb-3">
                                    <label for="newSpecName" class="form-label">Specification Name</label>
                                    <input type="text" class="form-control" id="newSpecName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="newSpecValue" class="form-label">Specification Value</label>
                                    <input type="text" class="form-control" id="newSpecValue" required>
                                </div>
                                <div id="addedSpecificationsList" class="mt-3"></div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeSpecificationModal">Close</button>
                            <button type="button" class="btn btn-primary" id="addNewSpecification">Add Specification</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Initialize the Bootstrap modal
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
            
            // Track added specifications in this session
            const addedSpecifications = [];
            const updateAddedSpecificationsList = () => {
                const listElement = document.getElementById('addedSpecificationsList');
                const closeButton = document.getElementById('closeSpecificationModal');
                
                if (addedSpecifications.length === 0) {
                    listElement.innerHTML = '';
                    // Change button text to "Close" if no specifications added
                    if (closeButton) {
                        closeButton.textContent = 'Close';
                        closeButton.classList.remove('btn-success');
                        closeButton.classList.add('btn-secondary');
                    }
                    return;
                }
                
                // Change button text to "Save" if specifications were added
                if (closeButton) {
                    closeButton.textContent = 'Save';
                    closeButton.classList.remove('btn-secondary');
                    closeButton.classList.add('btn-success');
                }
                
                listElement.innerHTML = `
                    <h6>Added Specifications:</h6>
                    <ul class="list-group">
                        ${addedSpecifications.map(spec => `<li class="list-group-item"><strong>${spec.name}:</strong> ${spec.value}</li>`).join('')}
                    </ul>
                `;
            };
            
            // Handle add button click
            document.getElementById('addNewSpecification').addEventListener('click', async () => {
                const specName = document.getElementById('newSpecName').value.trim();
                const specValue = document.getElementById('newSpecValue').value.trim();
                
                if (!specName || !specValue) {
                    alert('Please fill in all required fields');
                    return;
                }
                
                try {
                    const response = await fetchWithAuth(`${API_URL}/products/${productId}/specifications?specName=${encodeURIComponent(specName)}&specValue=${encodeURIComponent(specValue)}`, {
                        method: 'POST'
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.text();
                        throw new Error(errorData || 'Failed to add specification');
                    }
                    
                    // Add to the list of added specifications
                    addedSpecifications.push({name: specName, value: specValue});
                    updateAddedSpecificationsList();
                    
                    // Clear the inputs for next specification
                    document.getElementById('newSpecName').value = '';
                    document.getElementById('newSpecValue').value = '';
                    
                } catch (error) {
                    console.error('Error adding specification:', error);
                    alert('Error adding specification: ' + error.message);
                }
            });
            
            // Handle modal close - reload products
            modal.addEventListener('hidden.bs.modal', async () => {
                if (addedSpecifications.length > 0) {
                    await loadProducts();
                }
            });
        }

        // Add more certifications to an existing product
        async function addMoreCertifications(productId) {
            // Create a modal for adding new certifications
            const modalId = 'addCertificationsModal';
            let modal = document.getElementById(modalId);
            
            // Remove existing modal if it exists
            if (modal) {
                document.body.removeChild(modal);
            }
            
            // Create new modal
            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal fade';
            modal.tabIndex = '-1';
            modal.role = 'dialog';
            modal.setAttribute('aria-hidden', 'true');
            
            // First load available certifications
            let certifications = [];
            try {
                const response = await fetchWithAuth(`${API_URL}/certifications`);
                if (response.ok) {
                    certifications = await response.json();
                } else {
                    throw new Error('Failed to load certifications');
                }
            } catch (error) {
                console.error('Error loading certifications:', error);
                alert('Error loading certifications: ' + error.message);
                return;
            }
            
            // Get current product certifications to avoid adding duplicates
            let currentCertifications = [];
            try {
                const response = await fetchWithAuth(`${API_URL}/products/${productId}/certifications`);
                if (response.ok) {
                    currentCertifications = await response.json();
                }
            } catch (error) {
                console.error('Error loading current certifications:', error);
            }
            
            // Filter out certifications that are already added
            const availableCertifications = certifications.filter(cert => 
                !currentCertifications.some(currentCert => currentCert.id === cert.id)
            );
            
            if (availableCertifications.length === 0) {
                alert('All available certifications have already been added to this product.');
                return;
            }
            
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Certifications</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="addCertificationsForm">
                                <div class="mb-3">
                                    <label for="certificationSelect" class="form-label">Select Certification</label>
                                    <select class="form-control" id="certificationSelectModal">
                                        ${availableCertifications.map(cert => 
                                            `<option value="${cert.id}">${cert.name}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div id="addedCertificationsList" class="mt-3"></div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeCertificationModal">Close</button>
                            <button type="button" class="btn btn-primary" id="addCertificationToProduct">Add Certification</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Initialize the Bootstrap modal
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
            
            // Track added certifications in this session
            const addedCertifications = [];
            const updateAddedCertificationsList = () => {
                const listElement = document.getElementById('addedCertificationsList');
                const closeButton = document.getElementById('closeCertificationModal');
                
                if (addedCertifications.length === 0) {
                    listElement.innerHTML = '';
                    // Change button text to "Close" if no certifications added
                    if (closeButton) {
                        closeButton.textContent = 'Close';
                        closeButton.classList.remove('btn-success');
                        closeButton.classList.add('btn-secondary');
                    }
                    return;
                }
                
                // Change button text to "Save" if certifications were added
                if (closeButton) {
                    closeButton.textContent = 'Save';
                    closeButton.classList.remove('btn-secondary');
                    closeButton.classList.add('btn-success');
                }
                
                listElement.innerHTML = `
                    <h6>Added Certifications:</h6>
                    <ul class="list-group">
                        ${addedCertifications.map(cert => `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                ${cert.name}
                                <button class="btn btn-sm btn-danger" onclick="removeAddedCertFromList(${cert.id})" type="button">Remove</button>
                            </li>
                        `).join('')}
                    </ul>
                `;
            };
            
            // Global function to remove certification from the list in the modal
            window.removeAddedCertFromList = function(certId) {
                const index = addedCertifications.findIndex(c => c.id == certId);
                if (index !== -1) {
                    const removedCert = addedCertifications.splice(index, 1)[0];
                    
                    // Add the option back to the select dropdown
                    const select = document.getElementById('certificationSelectModal');
                    const option = document.createElement('option');
                    option.value = removedCert.id;
                    option.textContent = removedCert.name;
                    select.appendChild(option);
                    
                    // Re-enable the add button if it was disabled
                    document.getElementById('addCertificationToProduct').disabled = false;
                    
                    updateAddedCertificationsList();
                }
            };
            
            // Handle add button click
            document.getElementById('addCertificationToProduct').addEventListener('click', async () => {
                const select = document.getElementById('certificationSelectModal');
                if (!select) {
                    console.error('Certification select dropdown not found');
                    alert('Error: Certification select dropdown not found');
                    return;
                }
                
                const certId = select.value;
                const certName = select.options[select.selectedIndex]?.text;
                
                if (!certId || !certName) {
                    console.error('No certification selected', { certId, certName, options: select.options.length });
                    alert('Please select a certification');
                    return;
                }
                
                try {
                    const response = await fetchWithAuth(`${API_URL}/products/${productId}/certifications/${certId}`, {
                        method: 'POST'
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.text();
                        throw new Error(errorData || 'Failed to add certification');
                    }
                    
                    // Add to the list of added certifications
                    addedCertifications.push({id: certId, name: certName});
                    updateAddedCertificationsList();
                    
                    // Remove the added certification from the dropdown
                    const option = select.querySelector(`option[value="${certId}"]`);
                    if (option) {
                        select.removeChild(option);
                    }
                    
                    // If no more certifications are available, disable the add button
                    if (select.options.length === 0) {
                        document.getElementById('addCertificationToProduct').disabled = true;
                        select.innerHTML = '<option value="">No more certifications available</option>';
                    }
                    
                } catch (error) {
                    console.error('Error adding certification:', error);
                    alert('Error adding certification: ' + error.message);
                }
            });
            
            // Handle modal close - reload products
            modal.addEventListener('hidden.bs.modal', async () => {
                if (addedCertifications.length > 0) {
                    await loadProducts();
                }
            });
        }

        // Edit basic product information
        async function editProductBasicInfo(productId, productData) {
            // Create a modal for editing product basic info
            const modalId = 'editProductBasicInfoModal';
            let modal = document.getElementById(modalId);
            
            // Remove existing modal if it exists
            if (modal) {
                document.body.removeChild(modal);
            }
            
            // Load categories for the dropdown
            let categories = [];
            try {
                const response = await fetchWithAuth(`${API_URL}/categories`);
                if (response.ok) {
                    categories = await response.json();
                } else {
                    throw new Error('Failed to load categories');
                }
            } catch (error) {
                console.error('Error loading categories:', error);
                alert('Error loading categories: ' + error.message);
                return;
            }
            
            // Create new modal
            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal fade';
            modal.tabIndex = '-1';
            modal.role = 'dialog';
            modal.setAttribute('aria-hidden', 'true');
            
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Product Details</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editProductBasicInfoForm">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="editProductName" class="form-label">Product Name</label>
                                        <input type="text" class="form-control" id="editProductName" value="${productData.name.replace(/"/g, '&quot;')}" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="editProductCategory" class="form-label">Category</label>
                                        <select class="form-control" id="editProductCategory" required>
                                            <option value="">Select Category</option>
                                            ${categories.map(category => 
                                                `<option value="${category.id}" ${productData.category && productData.category.id === category.id ? 'selected' : ''}>${category.name}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="editProductDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="editProductDescription" rows="3">${productData.description || ''}</textarea>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="editProductPrice" class="form-label">Price per KG</label>
                                        <input type="number" class="form-control" id="editProductPrice" step="0.01" value="${productData.pricePerKg}" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="editProductInventory" class="form-label">Inventory</label>
                                        <input type="number" class="form-control" id="editProductInventory" value="${productData.inventory}" required>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="editProductNewArrival" ${productData.isNewArrival ? 'checked' : ''}>
                                            <label class="form-check-label" for="editProductNewArrival">New Arrival</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="editProductBestSeller" ${productData.isBestSeller ? 'checked' : ''}>
                                            <label class="form-check-label" for="editProductBestSeller">Best Seller</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="editProductFeatured" ${productData.isFeatured ? 'checked' : ''}>
                                            <label class="form-check-label" for="editProductFeatured">Featured</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="editProductHasDiscount" ${productData.hasDiscount ? 'checked' : ''} onchange="toggleDiscountField()">
                                            <label class="form-check-label" for="editProductHasDiscount">Has Discount</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3" id="discountPercentageField" style="display: ${productData.hasDiscount ? 'block' : 'none'}">
                                    <label for="editProductDiscountPercentage" class="form-label">Discount Percentage</label>
                                    <input type="number" class="form-control" id="editProductDiscountPercentage" min="0" max="100" value="${productData.discountPercentage || 0}">
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="saveProductBasicInfo">Save Changes</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Initialize the Bootstrap modal
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
            
            // Function to toggle discount percentage field
            window.toggleDiscountField = function() {
                const hasDiscount = document.getElementById('editProductHasDiscount').checked;
                document.getElementById('discountPercentageField').style.display = hasDiscount ? 'block' : 'none';
            };
            
            // Handle save button click
            document.getElementById('saveProductBasicInfo').addEventListener('click', async () => {
                const name = document.getElementById('editProductName').value.trim();
                const categoryId = document.getElementById('editProductCategory').value;
                const description = document.getElementById('editProductDescription').value.trim();
                const pricePerKg = document.getElementById('editProductPrice').value;
                const inventory = document.getElementById('editProductInventory').value;
                const isNewArrival = document.getElementById('editProductNewArrival').checked;
                const isBestSeller = document.getElementById('editProductBestSeller').checked;
                const isFeatured = document.getElementById('editProductFeatured').checked;
                const hasDiscount = document.getElementById('editProductHasDiscount').checked;
                const discountPercentage = document.getElementById('editProductDiscountPercentage').value;
                
                if (!name || !categoryId || !pricePerKg || !inventory) {
                    alert('Please fill in all required fields');
                    return;
                }
                
                try {
                    const productUpdateData = {
                        name: name,
                        categoryId: categoryId,
                        description: description,
                        pricePerKg: parseFloat(pricePerKg),
                        inventory: parseInt(inventory),
                        isNewArrival: isNewArrival,
                        isBestSeller: isBestSeller,
                        isFeatured: isFeatured,
                        hasDiscount: hasDiscount,
                        discountPercentage: hasDiscount ? parseInt(discountPercentage) : 0
                    };
                    
                    const response = await fetchWithAuth(`${API_URL}/products/${productId}/update-basic-info`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(productUpdateData)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.text();
                        throw new Error(errorData || 'Failed to update product information');
                    }
                    
                    // Show success message
                    alert('Product information updated successfully');
                    
                    // Close the modal
                    bootstrapModal.hide();
                    
                    // Check if we need to update the featured products
                    if (isNewArrival || isBestSeller || isFeatured) {
                        await fetchWithAuth(`${API_URL}/products/featured`, {
                            method: 'POST'
                        });
                    }
                    
                    // Reload the products to show the updated information
                    await loadProducts();
                } catch (error) {
                    console.error('Error updating product information:', error);
                    alert('Error updating product information: ' + error.message);
                }
            });
        }

        // Edit certification
        async function editCertification(certId, certName, certDescription) {
            // Create a modal for editing certification
            const modalId = 'editCertificationModal';
            let modal = document.getElementById(modalId);
            
            // Remove existing modal if it exists
            if (modal) {
                document.body.removeChild(modal);
            }
            
            // Create new modal
            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal fade';
            modal.tabIndex = '-1';
            modal.role = 'dialog';
            modal.setAttribute('aria-hidden', 'true');
            
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Certification</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editCertificationForm">
                                <div class="mb-3">
                                    <label for="editCertificationName" class="form-label">Name</label>
                                    <input type="text" class="form-control" id="editCertificationName" value="${certName.replace(/"/g, '&quot;')}" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editCertificationDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="editCertificationDescription" rows="3">${certDescription || ''}</textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="saveCertification">Save Changes</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Initialize the Bootstrap modal
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
            
            // Handle save button click
            document.getElementById('saveCertification').addEventListener('click', async () => {
                const name = document.getElementById('editCertificationName').value.trim();
                const description = document.getElementById('editCertificationDescription').value.trim();
                
                if (!name) {
                    alert('Certification name is required');
                    return;
                }
                
                try {
                    const certificationData = {
                        id: certId,
                        name: name,
                        description: description
                    };
                    
                    // Try PUT first
                    const response = await fetchWithAuth(`${API_URL}/certifications/${certId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(certificationData)
                    });
                    
                    if (!response.ok) {
                        // If PUT fails, try POST as fallback
                        if (response.status === 404 || response.status === 405) {
                            const fallbackResponse = await fetchWithAuth(`${API_URL}/certifications/${certId}/update`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(certificationData)
                            });
                            
                            if (!fallbackResponse.ok) {
                                const errorData = await fallbackResponse.text();
                                throw new Error(errorData || 'Failed to update certification');
                            }
                        } else {
                            const errorData = await response.text();
                            throw new Error(errorData || 'Failed to update certification');
                        }
                    }
                    
                    // Show success message
                    alert('Certification updated successfully');
                    
                    // Close the modal
                    bootstrapModal.hide();
                    
                    // Reload certifications and products to show the updated information
                    await loadCertifications();
                    await loadProducts();
                } catch (error) {
                    console.error('Error updating certification:', error);
                    alert('Error updating certification: ' + error.message);
                }
            });
        }

        // Remove product certification
        async function removeProductCertification(productId, certificationId) {
            if (confirm('Are you sure you want to remove this certification from the product?')) {
                try {
                    const response = await fetchWithAuth(`${API_URL}/products/${productId}/certifications/${certificationId}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.text();
                        throw new Error(errorData || 'Failed to remove certification from product');
                    }
                    
                    // Show success message
                    alert('Certification removed from product successfully');
                    
                    // Reload the products to show the updated certifications
                    await loadProducts();
                } catch (error) {
                    console.error('Error removing certification from product:', error);
                    alert('Error removing certification from product: ' + error.message);
                }
            }
        }

        // Function to check user role and show/hide admin links
        async function checkUserRole() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('http://localhost:8080/api/auth/user', {
                    headers: token ? { 'Authorization': 'Bearer ' + token } : {}
                });
                const user = await response.json();
                if (user.roles && user.roles.includes('ROLE_ADMIN')) {
                    document.getElementById('addWorkerLink').style.display = 'block';
                }
            } catch (error) {
                console.error('Error checking user role:', error);
            }
        }
        // Call checkUserRole after login
        checkUserRole();
    </script>
</body>
</html> 